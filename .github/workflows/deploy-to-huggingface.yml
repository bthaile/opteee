name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main

      - name: Create Docker startup script
        run: |
          cat > startup.sh <<'EOF'
          #!/bin/bash
          set -e
          
          echo "===== Setting up environment ====="
          
          # Function to try creating directories and return success/failure
          try_dir() {
              local base_dir=$1
              local mpl_dir="$base_dir/matplotlib"
              local hf_dir="$base_dir/huggingface"
              
              echo "Trying to create cache directories in $base_dir..."
              if mkdir -p "$mpl_dir" "$hf_dir" 2>/dev/null; then
                  echo "SUCCESS: Created cache directories in $base_dir"
                  export MPLCONFIGDIR="$mpl_dir"
                  export TRANSFORMERS_CACHE="$hf_dir"
                  export XDG_CACHE_HOME="$base_dir"
                  export XDG_CONFIG_HOME="$base_dir"
                  return 0
              else
                  echo "FAILED: Could not create directories in $base_dir"
                  return 1
              fi
          }
          
          # Export HOME as current directory
          export HOME=$(pwd)
          echo "HOME set to: $HOME"
          
          # Try several locations in order of preference
          if try_dir "$HOME/.cache"; then
              echo "Using home directory for cache"
          elif try_dir "/tmp"; then
              echo "Using /tmp for cache"
          elif try_dir "/var/tmp"; then
              echo "Using /var/tmp for cache"
          else
              echo "WARNING: Could not create cache directories in any location!"
              echo "Python libraries may fail to load models or create visualizations."
          fi
          
          # Print current environment settings
          echo "MPLCONFIGDIR: $MPLCONFIGDIR"
          echo "TRANSFORMERS_CACHE: $TRANSFORMERS_CACHE"
          echo "XDG_CACHE_HOME: $XDG_CACHE_HOME"
          echo "XDG_CONFIG_HOME: $XDG_CONFIG_HOME"
          echo "HOME: $HOME"
          echo "Current directory: $(pwd)"
          echo "Current user: $(whoami)"
          
          # Set Python path
          export PYTHONPATH=/app
          
          echo "===== Starting application ====="
          date
          
          # Run the application
          python app.py
          EOF
          
          chmod +x startup.sh
          
      - name: Update README for Hugging Face
        run: |
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: ðŸ”¥
          colorFrom: blue
          colorTo: red
          sdk: docker
          app_port: 7860
          pinned: false
          env:
            - PYTHONPATH=/app
          ---
          
          # Options Trading Knowledge Search
          
          This application provides semantic search across a collection of options trading transcripts and videos.
          
          ## Features
          
          - Semantic search using sentence-transformers
          - FAISS vector database for fast retrieval
          - Direct links to specific timestamps in relevant videos
          EOF
          
      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with Docker"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 