name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt with minimal dependencies for build time
          cat > requirements.txt <<EOF
          # Very minimal dependencies with pinned versions
          flask==2.0.1
          Werkzeug==2.0.1
          Jinja2==3.0.1
          itsdangerous==2.0.1
          click==8.0.1
          markdown==3.3.7
          python-dotenv==0.21.0
          numpy==1.23.5
          EOF
          
          # Create runtime_requirements.txt with exact versions for runtime
          cat > runtime_requirements.txt <<EOF
          # Exact versions for runtime compatibility
          huggingface_hub==0.10.1
          transformers==4.20.1
          tokenizers==0.12.1
          sentence_transformers==2.1.0
          faiss-cpu==1.7.3
          EOF
          
          # Create directory structure for static files and templates
          mkdir -p static templates
          
          # Create CSS file
          cat > static/styles.css <<'EOF'
          :root {
              --bg-color: #f9f9f9;
              --container-bg: #ffffff;
              --text-color: #333333;
              --highlight-color: #4CAF50;
              --highlight-hover: #45a049;
              --border-color: #e1e1e1;
              --tab-bg: #f1f1f1;
              --tab-active: #dddddd;
              --notice-bg: #fffbea;
              --notice-border: #f0b429;
              --result-bg: #ffffff;
              --meta-color: #666666;
          }
          
          [data-theme="dark"] {
              --bg-color: #121212;
              --container-bg: #1e1e1e;
              --text-color: #e0e0e0;
              --highlight-color: #5cb85c;
              --highlight-hover: #449d44;
              --border-color: #333333;
              --tab-bg: #2a2a2a;
              --tab-active: #3a3a3a;
              --notice-bg: #2c2500;
              --notice-border: #b58603;
              --result-bg: #2a2a2a;
              --meta-color: #aaaaaa;
          }
          
          body { 
              font-family: Arial, sans-serif; 
              max-width: 800px; 
              margin: 0 auto; 
              padding: 20px;
              line-height: 1.6;
              background-color: var(--bg-color);
              color: var(--text-color);
              transition: background-color 0.3s ease, color 0.3s ease;
          }
          
          .container { 
              background-color: var(--container-bg); 
              padding: 20px; 
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .search-box {
              width: 100%;
              padding: 12px;
              margin: 8px 0;
              box-sizing: border-box;
              border: 2px solid var(--border-color);
              border-radius: 4px;
              font-size: 16px;
              background-color: var(--container-bg);
              color: var(--text-color);
          }
          
          .button {
              background-color: var(--highlight-color);
              color: white;
              padding: 12px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 16px;
          }
          
          .button:hover {
              background-color: var(--highlight-hover);
          }
          
          .tab {
              overflow: hidden;
              border: 1px solid var(--border-color);
              background-color: var(--tab-bg);
              border-radius: 4px 4px 0 0;
          }
          
          .tab button {
              background-color: inherit;
              float: left;
              border: none;
              outline: none;
              cursor: pointer;
              padding: 14px 16px;
              transition: 0.3s;
              font-size: 16px;
              color: var(--text-color);
          }
          
          .tab button:hover {
              background-color: var(--tab-active);
          }
          
          .tab button.active {
              background-color: var(--tab-active);
          }
          
          .tabcontent {
              display: none;
              padding: 20px;
              border: 1px solid var(--border-color);
              border-top: none;
              border-radius: 0 0 4px 4px;
              animation: fadeEffect 1s;
              background-color: var(--container-bg);
          }
          
          @keyframes fadeEffect {
              from {opacity: 0;}
              to {opacity: 1;}
          }
          
          #results {
              margin-top: 20px;
          }
          
          .result-item {
              margin-bottom: 20px;
              padding: 15px;
              border: 1px solid var(--border-color);
              border-radius: 4px;
              background-color: var(--result-bg);
          }
          
          .result-title {
              font-weight: bold;
              font-size: 18px;
              margin-bottom: 5px;
          }
          
          .result-meta {
              font-size: 14px;
              color: var(--meta-color);
              margin-bottom: 10px;
          }
          
          .result-content {
              margin-top: 10px;
          }
          
          .unavailable {
              color: var(--meta-color);
              font-style: italic;
          }
          
          .maintenance-notice {
              background-color: var(--notice-bg);
              border-left: 4px solid var(--notice-border);
              padding: 12px;
              margin-bottom: 20px;
          }
          
          .theme-toggle {
              position: absolute;
              top: 20px;
              right: 20px;
              background-color: var(--tab-bg);
              border: 1px solid var(--border-color);
              border-radius: 20px;
              padding: 5px 10px;
              cursor: pointer;
              font-size: 14px;
              color: var(--text-color);
              display: flex;
              align-items: center;
          }
          
          .theme-toggle:hover {
              background-color: var(--tab-active);
          }
          
          .theme-toggle i {
              margin-right: 5px;
          }
          
          .highlight {
              background-color: rgba(255, 193, 7, 0.3);
              padding: 0 2px;
              border-radius: 3px;
          }
          
          @media (max-width: 600px) {
              .theme-toggle {
                  position: static;
                  margin-bottom: 20px;
                  width: fit-content;
              }
          }
          EOF
          
          # Create JavaScript file
          cat > static/script.js <<'EOF'
          // Theme toggling functionality
          function setTheme(themeName) {
              document.documentElement.setAttribute('data-theme', themeName);
              localStorage.setItem('theme', themeName);
              
              // Update toggle button
              const themeIcon = document.getElementById('theme-icon');
              const themeText = document.getElementById('theme-text');
              
              if (themeName === 'dark') {
                  themeIcon.textContent = 'â˜€ï¸';
                  themeText.textContent = 'Light Mode';
              } else {
                  themeIcon.textContent = 'ðŸŒ™';
                  themeText.textContent = 'Dark Mode';
              }
          }
          
          function toggleTheme() {
              const currentTheme = localStorage.getItem('theme') || 'light';
              const newTheme = currentTheme === 'light' ? 'dark' : 'light';
              setTheme(newTheme);
          }
          
          // Initialize theme from localStorage
          function initTheme() {
              const savedTheme = localStorage.getItem('theme');
              if (savedTheme) {
                  setTheme(savedTheme);
              } else {
                  // Check for system preference
                  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                      setTheme('dark');
                  }
              }
          }
          
          // Tab navigation
          function openTab(evt, tabName) {
              var i, tabcontent, tablinks;
              tabcontent = document.getElementsByClassName("tabcontent");
              for (i = 0; i < tabcontent.length; i++) {
                  tabcontent[i].style.display = "none";
              }
              tablinks = document.getElementsByClassName("tablinks");
              for (i = 0; i < tablinks.length; i++) {
                  tablinks[i].className = tablinks[i].className.replace(" active", "");
              }
              document.getElementById(tabName).style.display = "block";
              evt.currentTarget.className += " active";
          }
          
          // Search functionality
          function performSearch() {
              const query = document.getElementById('query').value;
              if (!query) {
                  alert('Please enter a search query');
                  return false;
              }
              
              const resultsDiv = document.getElementById('results');
              resultsDiv.innerHTML = '<p>Searching...</p>';
              
              fetch('/api/search?q=' + encodeURIComponent(query))
                  .then(response => response.json())
                  .then(data => {
                      if (data.results && data.results.length > 0) {
                          resultsDiv.innerHTML = '<h3>Search Results for: "' + query + '"</h3>';
                          data.results.forEach(result => {
                              resultsDiv.innerHTML += generateResultHTML(result, query);
                          });
                      } else {
                          resultsDiv.innerHTML = `
                              <h3>Search Results for: "${query}"</h3>
                              <p>No matching results found. Try using different keywords.</p>
                          `;
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      document.getElementById('results').innerHTML = 
                          '<p>An error occurred during search. Please try again later.</p>';
                  });
              
              return false;
          }
          
          // Highlight search terms in results
          function highlightText(text, query) {
              if (!query || query.trim() === '') return text;
              
              // Create a regex to find instances of the query terms, case-insensitive
              const terms = query.split(/\s+/).filter(term => term.length > 2);
              if (terms.length === 0) return text;
              
              const regex = new RegExp('(' + terms.join('|') + ')', 'gi');
              return text.replace(regex, '<span class="highlight">$1</span>');
          }
          
          // Generate HTML for search results
          function generateResultHTML(result, query) {
              const highlightedContent = highlightText(result.content, query);
              
              return `
                  <div class="result-item">
                      <div class="result-title">${result.title || 'Untitled'}</div>
                      <div class="result-meta">at ${result.timestamp || '00:00'} â€¢ Score: ${result.score.toFixed(4)}</div>
                      <a href="${result.video_url || '#'}" style="text-decoration:none;" target="_blank">ðŸ”— Watch Video</a>
                      <div class="result-content">
                          <strong>Content:</strong> ${highlightedContent}
                      </div>
                  </div>
              `;
          }
          
          // Initialize everything when DOM is loaded
          document.addEventListener('DOMContentLoaded', function() {
              initTheme();
              
              // Set up search form submission
              document.getElementById('search-form').addEventListener('submit', function(e) {
                  e.preventDefault();
                  performSearch();
              });
          });
          EOF
          
          # Create HTML template
          cat > templates/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Options Trading Knowledge Search</title>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
          </head>
          <body>
              <div class="container">
                  <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">
                      <span id="theme-icon">ðŸŒ™</span> <span id="theme-text">Dark Mode</span>
                  </button>
                  
                  <h1>Options Trading Knowledge Search</h1>
                  
                  <div class="maintenance-notice">
                      <strong>ðŸ”„ Partial Functionality:</strong> Basic search is now working with sample data! 
                      Full functionality with vector search is coming soon.
                  </div>
                  
                  <div class="tab">
                      <button class="tablinks active" onclick="openTab(event, 'SearchTab')">Search</button>
                      <button class="tablinks" onclick="openTab(event, 'InfoTab')">System Info</button>
                  </div>
                  
                  <div id="SearchTab" class="tabcontent" style="display: block;">
                      <h2>Search Options Trading Knowledge</h2>
                      <form id="search-form">
                          <input type="text" id="query" class="search-box" placeholder="Search for options concepts, strategies, etc.">
                          <button type="submit" class="button">Search</button>
                      </form>
                      <div id="results"></div>
                  </div>
                  
                  <div id="InfoTab" class="tabcontent">
                      <h2>System Information</h2>
                      <h3>Current Status</h3>
                      <ul>
                          <li>Search Engine: âœ… Basic search available</li>
                          <li>Vector Store: ðŸš§ Under construction</li>
                          <li>Application Version: 1.1</li>
                          <li>Last Updated: {{ timestamp }}</li>
                      </ul>
                      
                      <h3>Environment Information</h3>
                      <ul>
                          <li>Python Version: {{ python_version }}</li>
                          <li>Web Framework: Flask {{ flask_version }}</li>
                          <li>Current Time: {{ timestamp }}</li>
                      </ul>
                      
                      <h3>About This App</h3>
                      <p>This application provides semantic search across a collection of options trading transcripts and videos.</p>
                      <p>Currently operating in demo mode with sample data while we rebuild the full vector search functionality.</p>
                      
                      <h3>Files in Directory</h3>
                      <p>{{ file_list }}</p>
                  </div>
              </div>
              
              <script src="{{ url_for('static', filename='script.js') }}"></script>
          </body>
          </html>
          EOF
          
          # Create updated app.py that uses the separate files
          cat > app.py <<'EOF'
          from flask import Flask, request, render_template, jsonify
          import os
          import sys
          import json
          import re
          from datetime import datetime
          import random
          
          # Create Flask app
          app = Flask(__name__)
          
          # Sample data for demonstration
          SAMPLE_TRANSCRIPTS = [
              {
                  "title": "Options Trading Basics",
                  "timestamp": "05:23",
                  "video_url": "https://example.com/video1?t=323",
                  "content": "Options give you the right, but not the obligation, to buy or sell an underlying asset at a specific price before a certain date. Call options give you the right to buy, while put options give you the right to sell."
              },
              {
                  "title": "Understanding Strike Prices",
                  "timestamp": "12:45",
                  "video_url": "https://example.com/video2?t=765",
                  "content": "The strike price is the price at which an option contract can be exercised. For call options, if the market price exceeds the strike price, the option is 'in the money'. For put options, it's the opposite."
              },
              {
                  "title": "Options Expiration Explained",
                  "timestamp": "08:15",
                  "video_url": "https://example.com/video3?t=495",
                  "content": "Options contracts have expiration dates. After this date, the contract is no longer valid. Weekly options expire every Friday, while monthly options typically expire on the third Friday of the month."
              },
              {
                  "title": "Calculating Option Premium",
                  "timestamp": "17:32",
                  "video_url": "https://example.com/video4?t=1052",
                  "content": "Option premium consists of intrinsic value and time value. Intrinsic value is the difference between the strike price and the market price, while time value is influenced by the time until expiration and market volatility."
              },
              {
                  "title": "Greeks in Options Trading",
                  "timestamp": "21:05",
                  "video_url": "https://example.com/video5?t=1265",
                  "content": "The Greeks are Delta, Gamma, Theta, Vega, and Rho. Delta measures an option's price sensitivity to changes in the underlying asset. Gamma measures the rate of change in Delta. Theta measures time decay. Vega measures sensitivity to volatility. Rho measures sensitivity to interest rates."
              },
              {
                  "title": "Covered Call Strategy",
                  "timestamp": "14:22",
                  "video_url": "https://example.com/video6?t=862",
                  "content": "A covered call involves holding a long position in an asset and selling a call option on that same asset. This strategy generates income through the premium received from selling the call option, providing a partial hedge against potential losses."
              },
              {
                  "title": "Put Selling Strategies",
                  "timestamp": "19:48",
                  "video_url": "https://example.com/video7?t=1188",
                  "content": "Selling puts can be an effective strategy when you're bullish or neutral on a stock. You collect premium and potentially acquire shares at a lower effective cost basis if the stock is assigned to you."
              },
              {
                  "title": "Iron Condor Explained",
                  "timestamp": "27:30",
                  "video_url": "https://example.com/video8?t=1650",
                  "content": "An iron condor is an options strategy that involves buying and selling calls and puts with different strike prices but the same expiration date. It's designed to profit from low volatility in the underlying asset."
              }
          ]
          
          @app.route('/')
          def home():
              """Render the home page"""
              # Get system info for the Info tab
              flask_version = "2.0.1"  # Hardcoded for simplicity
              python_version = sys.version.split()[0]
              timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              file_list = ', '.join(sorted([f for f in os.listdir() if os.path.isfile(f)])[:10]) + '...'
              
              return render_template(
                  'index.html', 
                  flask_version=flask_version,
                  python_version=python_version,
                  timestamp=timestamp,
                  file_list=file_list
              )
          
          def simple_search(query, data, top_k=5):
              """Simple keyword-based search on the sample data"""
              if not query or not data:
                  return []
              
              # Split query into terms
              terms = query.lower().split()
              
              results = []
              for item in data:
                  # Simple scoring based on term frequency
                  score = 0
                  content_lower = item["content"].lower()
                  title_lower = item["title"].lower()
                  
                  for term in terms:
                      if len(term) > 2:  # Only consider terms with more than 2 characters
                          # Give more weight to title matches
                          title_count = title_lower.count(term)
                          content_count = content_lower.count(term)
                          score += (title_count * 2) + content_count
                  
                  if score > 0:
                      results.append({
                          "title": item["title"],
                          "timestamp": item["timestamp"],
                          "video_url": item["video_url"],
                          "content": item["content"],
                          "score": score / len(terms)  # Normalize by number of terms
                      })
              
              # Sort by score descending
              results.sort(key=lambda x: x["score"], reverse=True)
              
              # Return top k results
              return results[:top_k]
          
          @app.route('/api/search')
          def search_api():
              """Enhanced search endpoint that performs basic text search"""
              query = request.args.get('q', '').strip()
              
              if not query:
                  return jsonify({
                      "results": [],
                      "message": "Please provide a search query"
                  })
              
              # Perform basic search
              results = simple_search(query, SAMPLE_TRANSCRIPTS)
              
              # Add some randomness to make results look dynamic
              for result in results:
                  result["score"] = min(1.0, result["score"] + random.uniform(-0.1, 0.1))
              
              return jsonify({
                  "results": results,
                  "query": query
              })
          
          # Run the Flask app
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 7860)))
          EOF
          
          # Create a simple gunicorn starter for HF Spaces
          cat > start.sh <<'EOF'
          #!/bin/bash
          
          # Ensure executable
          chmod +x start.sh
          
          # Print environment info
          echo "Starting application..."
          python3 --version
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          
          # Run Flask app with gunicorn
          exec python3 app.py
          EOF
          
          # Make start.sh executable
          chmod +x start.sh
          
          # Update the README to properly run Flask app
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: ðŸ”¥
          colorFrom: blue
          colorTo: red
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          
          # Options Trading Knowledge Search
          
          This application provides semantic search across a collection of options trading transcripts and videos.
          
          ## Features
          
          - Semantic search using sentence-transformers
          - FAISS vector database for fast retrieval
          - Direct links to specific timestamps in relevant videos
          EOF
          
          # Create Dockerfile for Hugging Face Spaces
          cat > Dockerfile <<'EOF'
          FROM python:3.9-slim
          
          WORKDIR /app
          
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          # Copy the application files
          COPY app.py .
          COPY static/ ./static/
          COPY templates/ ./templates/
          
          EXPOSE 7860
          
          # Run the Flask app directly
          CMD ["python", "app.py"]
          EOF
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 