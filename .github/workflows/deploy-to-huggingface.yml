name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'discord/**'  # Exclude discord directory - it has its own deployment
  workflow_dispatch:  # Allows manual triggering
  repository_dispatch:
    types:
      - transcript-update  # Trigger on transcript updates

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main

      - name: Create Docker startup script
        run: |
          cat > startup.sh <<'EOF'
          #!/bin/bash
          set -e
          
          echo "===== Starting application ====="
          date
          
          # Print environment for debugging
          echo "Current directory: $(pwd)"
          echo "Current user: $(whoami)"
          
          # Run the FastAPI application
          python main.py
          EOF
          
          chmod +x startup.sh
          
      - name: Update README for Hugging Face
        run: |
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: ðŸ”¥
          colorFrom: blue
          colorTo: red
          sdk: docker
          app_port: 7860
          pinned: false
          env:
            - PYTHONPATH=/app
          ---
          
          # Options Trading Knowledge Search
          
          This application provides semantic search across a collection of options trading transcripts and videos.
          
          ## Features
          
          - Semantic search using sentence-transformers
          - FAISS vector database for fast retrieval
          - Direct links to specific timestamps in relevant videos
          EOF
          
      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          set -e
          # Deploy in a staging directory so we never touch the original .git
          # This keeps the checkout intact if push fails and avoids destructive rm -rf
          DEPLOY_DIR="hf_deploy"
          rm -rf "$DEPLOY_DIR"
          mkdir -p "$DEPLOY_DIR"
          
          # Copy repo contents (exclude .git to keep deploy lean)
          rsync -a --exclude='.git' --exclude="$DEPLOY_DIR" . "$DEPLOY_DIR/"
          cd "$DEPLOY_DIR"
          
          # Configure git for the deploy artifact
          git config --global credential.helper store
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          git init
          git add .
          git commit -m "Deploy to Hugging Face with Docker"
          
          # Push using token URL for reliable auth
          git push --force "https://USER:${HF_TOKEN}@huggingface.co/spaces/${SPACE_NAME}" main 