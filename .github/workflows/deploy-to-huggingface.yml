name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt specifically for Hugging Face
          cat > requirements.txt <<EOF
          # Pin specific versions that work together
          torch==1.13.1
          transformers==4.31.0
          tokenizers==0.13.3
          # Vector store and other requirements
          faiss-cpu
          python-dotenv
          sentence_transformers
          # Add other dependencies below but don't specify versions unless needed
          EOF
          
          # Append existing requirements without versions
          if [ -f requirements.txt.orig ]; then
            grep -v "torch\|transformers\|tokenizers" requirements.txt.orig | grep -v "==" >> requirements.txt || true
          fi
          
          # Create a specific Hugging Face runtime.txt
          echo "python-3.10" > runtime.txt
          
          # Create new README with default configuration
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: ðŸ”¥
          colorFrom: blue
          colorTo: red
          sdk: gradio
          sdk_version: 4.19.2
          app_file: app.py
          pinned: false
          ---
          
          # HuggingFace Space for opteee
          
          This space runs with specific dependency versions:
          - torch==1.13.1
          - transformers==4.31.0
          - tokenizers==0.13.3
          EOF
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 