name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt with all necessary dependencies
          cat > requirements.txt <<EOF
          # Core dependencies with pinned versions
          flask==2.0.1
          Werkzeug==2.0.1
          Jinja2==3.0.1
          itsdangerous==2.0.1
          click==8.0.1
          python-dotenv==0.21.0
          
          # Vector search dependencies
          numpy==1.23.5
          sentence-transformers==2.1.0
          faiss-cpu==1.7.3
          torch==1.13.1
          
          # Utility libraries
          markdown==3.3.7
          tqdm==4.66.1
          EOF
          
          # Create runtime_requirements.txt with exact versions for runtime
          cat > runtime_requirements.txt <<EOF
          # Exact versions for runtime compatibility
          huggingface_hub==0.10.1
          transformers==4.20.1
          tokenizers==0.12.1
          sentence_transformers==2.1.0
          faiss-cpu==1.7.3
          EOF
          
          # Create directory structure for static files and templates
          mkdir -p static templates
          
          # Create CSS file
          cat > static/styles.css <<'EOF'
          :root {
              --bg-color: #f9f9f9;
              --container-bg: #ffffff;
              --text-color: #333333;
              --highlight-color: #4CAF50;
              --highlight-hover: #45a049;
              --border-color: #e1e1e1;
              --tab-bg: #f1f1f1;
              --tab-active: #dddddd;
              --notice-bg: #fffbea;
              --notice-border: #f0b429;
              --result-bg: #ffffff;
              --meta-color: #666666;
          }
          
          [data-theme="dark"] {
              --bg-color: #121212;
              --container-bg: #1e1e1e;
              --text-color: #e0e0e0;
              --highlight-color: #5cb85c;
              --highlight-hover: #449d44;
              --border-color: #333333;
              --tab-bg: #2a2a2a;
              --tab-active: #3a3a3a;
              --notice-bg: #2c2500;
              --notice-border: #b58603;
              --result-bg: #2a2a2a;
              --meta-color: #aaaaaa;
          }
          
          body { 
              font-family: Arial, sans-serif; 
              max-width: 800px; 
              margin: 0 auto; 
              padding: 20px;
              line-height: 1.6;
              background-color: var(--bg-color);
              color: var(--text-color);
              transition: background-color 0.3s ease, color 0.3s ease;
          }
          
          .container { 
              background-color: var(--container-bg); 
              padding: 20px; 
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .search-box {
              width: 100%;
              padding: 12px;
              margin: 8px 0;
              box-sizing: border-box;
              border: 2px solid var(--border-color);
              border-radius: 4px;
              font-size: 16px;
              background-color: var(--container-bg);
              color: var(--text-color);
          }
          
          .button {
              background-color: var(--highlight-color);
              color: white;
              padding: 12px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 16px;
          }
          
          .button:hover {
              background-color: var(--highlight-hover);
          }
          
          .tab {
              overflow: hidden;
              border: 1px solid var(--border-color);
              background-color: var(--tab-bg);
              border-radius: 4px 4px 0 0;
          }
          
          .tab button {
              background-color: inherit;
              float: left;
              border: none;
              outline: none;
              cursor: pointer;
              padding: 14px 16px;
              transition: 0.3s;
              font-size: 16px;
              color: var(--text-color);
          }
          
          .tab button:hover {
              background-color: var(--tab-active);
          }
          
          .tab button.active {
              background-color: var(--tab-active);
          }
          
          .tabcontent {
              display: none;
              padding: 20px;
              border: 1px solid var(--border-color);
              border-top: none;
              border-radius: 0 0 4px 4px;
              animation: fadeEffect 1s;
              background-color: var(--container-bg);
          }
          
          @keyframes fadeEffect {
              from {opacity: 0;}
              to {opacity: 1;}
          }
          
          #results {
              margin-top: 20px;
          }
          
          .result-item {
              margin-bottom: 20px;
              padding: 15px;
              border: 1px solid var(--border-color);
              border-radius: 4px;
              background-color: var(--result-bg);
          }
          
          .result-title {
              font-weight: bold;
              font-size: 18px;
              margin-bottom: 5px;
          }
          
          .result-meta {
              font-size: 14px;
              color: var(--meta-color);
              margin-bottom: 10px;
          }
          
          .result-content {
              margin-top: 10px;
          }
          
          .unavailable {
              color: var(--meta-color);
              font-style: italic;
          }
          
          .maintenance-notice {
              background-color: var(--notice-bg);
              border-left: 4px solid var(--notice-border);
              padding: 12px;
              margin-bottom: 20px;
          }
          
          .theme-toggle {
              position: absolute;
              top: 20px;
              right: 20px;
              background-color: var(--tab-bg);
              border: 1px solid var(--border-color);
              border-radius: 20px;
              padding: 5px 10px;
              cursor: pointer;
              font-size: 14px;
              color: var(--text-color);
              display: flex;
              align-items: center;
          }
          
          .theme-toggle:hover {
              background-color: var(--tab-active);
          }
          
          .theme-toggle i {
              margin-right: 5px;
          }
          
          .highlight {
              background-color: rgba(255, 193, 7, 0.3);
              padding: 0 2px;
              border-radius: 3px;
          }
          
          @media (max-width: 600px) {
              .theme-toggle {
                  position: static;
                  margin-bottom: 20px;
                  width: fit-content;
              }
          }
          
          /* Search type badges */
          .search-type-badge {
              display: inline-block;
              padding: 3px 6px;
              border-radius: 3px;
              font-size: 12px;
              margin-left: 10px;
              font-weight: normal;
          }
          
          .semantic-badge {
              background-color: var(--highlight-color);
              color: white;
          }
          
          .keyword-badge {
              background-color: #6c757d;
              color: white;
          }
          
          /* Status indicator */
          .status-indicator {
              display: inline-block;
              width: 12px;
              height: 12px;
              border-radius: 50%;
              margin-right: 5px;
          }
          
          .status-available {
              background-color: var(--highlight-color);
          }
          
          .status-building {
              background-color: #f0b429;
          }
          
          .status-unavailable {
              background-color: #dc3545;
          }
          EOF
          
          # Create JavaScript file
          cat > static/script.js <<'EOF'
          // Theme toggling functionality
          function setTheme(themeName) {
              document.documentElement.setAttribute('data-theme', themeName);
              localStorage.setItem('theme', themeName);
              
              // Update toggle button
              const themeIcon = document.getElementById('theme-icon');
              const themeText = document.getElementById('theme-text');
              
              if (themeName === 'dark') {
                  themeIcon.textContent = '‚òÄÔ∏è';
                  themeText.textContent = 'Light Mode';
              } else {
                  themeIcon.textContent = 'üåô';
                  themeText.textContent = 'Dark Mode';
              }
          }
          
          function toggleTheme() {
              const currentTheme = localStorage.getItem('theme') || 'light';
              const newTheme = currentTheme === 'light' ? 'dark' : 'light';
              setTheme(newTheme);
          }
          
          // Initialize theme from localStorage
          function initTheme() {
              const savedTheme = localStorage.getItem('theme');
              if (savedTheme) {
                  setTheme(savedTheme);
              } else {
                  // Check for system preference
                  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                      setTheme('dark');
                  }
              }
          }
          
          // Tab navigation
          function openTab(evt, tabName) {
              var i, tabcontent, tablinks;
              tabcontent = document.getElementsByClassName("tabcontent");
              for (i = 0; i < tabcontent.length; i++) {
                  tabcontent[i].style.display = "none";
              }
              tablinks = document.getElementsByClassName("tablinks");
              for (i = 0; i < tablinks.length; i++) {
                  tablinks[i].className = tablinks[i].className.replace(" active", "");
              }
              document.getElementById(tabName).style.display = "block";
              evt.currentTarget.className += " active";
          }
          
          // Search functionality
          function performSearch() {
              const query = document.getElementById('query').value;
              if (!query) {
                  alert('Please enter a search query');
                  return false;
              }
              
              const resultsDiv = document.getElementById('results');
              resultsDiv.innerHTML = '<p>Searching...</p>';
              
              fetch('/api/search?q=' + encodeURIComponent(query))
                  .then(response => response.json())
                  .then(data => {
                      if (data.results && data.results.length > 0) {
                          const searchTypeLabel = data.search_type === 'semantic' ? 
                              '<span style="background: #5cb85c; color: white; padding: 3px 6px; border-radius: 3px; font-size: 12px; margin-left: 10px;">SEMANTIC</span>' : 
                              '<span style="background: #6c757d; color: white; padding: 3px 6px; border-radius: 3px; font-size: 12px; margin-left: 10px;">KEYWORD</span>';
                          
                          resultsDiv.innerHTML = '<h3>Search Results for: "' + query + '"' + searchTypeLabel + '</h3>';
                          data.results.forEach(result => {
                              resultsDiv.innerHTML += generateResultHTML(result, query);
                          });
                      } else {
                          resultsDiv.innerHTML = `
                              <h3>Search Results for: "${query}"</h3>
                              <p>No matching results found. Try using different keywords.</p>
                          `;
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      document.getElementById('results').innerHTML = 
                          '<p>An error occurred during search. Please try again later.</p>';
                  });
              
              return false;
          }
          
          // Highlight search terms in results
          function highlightText(text, query) {
              if (!query || query.trim() === '') return text;
              
              // Create a regex to find instances of the query terms, case-insensitive
              const terms = query.split(/\s+/).filter(term => term.length > 2);
              if (terms.length === 0) return text;
              
              const regex = new RegExp('(' + terms.join('|') + ')', 'gi');
              return text.replace(regex, '<span class="highlight">$1</span>');
          }
          
          // Generate HTML for search results
          function generateResultHTML(result, query) {
              const highlightedContent = highlightText(result.content, query);
              
              return `
                  <div class="result-item">
                      <div class="result-title">${result.title || 'Untitled'}</div>
                      <div class="result-meta">at ${result.timestamp || '00:00'} ‚Ä¢ Score: ${result.score.toFixed(4)}</div>
                      <a href="${result.video_url || '#'}" style="text-decoration:none;" target="_blank">üîó Watch Video</a>
                      <div class="result-content">
                          <strong>Content:</strong> ${highlightedContent}
                      </div>
                  </div>
              `;
          }
          
          // Initialize everything when DOM is loaded
          document.addEventListener('DOMContentLoaded', function() {
              initTheme();
              
              // Set up search form submission
              document.getElementById('search-form').addEventListener('submit', function(e) {
                  e.preventDefault();
                  performSearch();
              });
          });
          EOF
          
          # Create HTML template
          cat > templates/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Options Trading Knowledge Search</title>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
          </head>
          <body>
              <div class="container">
                  <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">
                      <span id="theme-icon">üåô</span> <span id="theme-text">Dark Mode</span>
                  </button>
                  
                  <h1>Options Trading Knowledge Search</h1>
                  
                  <div class="maintenance-notice" id="status-notice">
                      <strong>üîÑ Status:</strong> 
                      {% if building_vector_store %}
                      Vector store is currently building. Basic search is available in the meantime.
                      {% else %}
                      Semantic search is {{ "available" if vector_status == "‚úÖ Available" else "not available" }}. 
                      {{ "Using keyword search as fallback." if vector_status != "‚úÖ Available" else "" }}
                      {% endif %}
                  </div>
                  
                  <div class="tab">
                      <button class="tablinks active" onclick="openTab(event, 'SearchTab')">Search</button>
                      <button class="tablinks" onclick="openTab(event, 'InfoTab')">System Info</button>
                  </div>
                  
                  <div id="SearchTab" class="tabcontent" style="display: block;">
                      <h2>Search Options Trading Knowledge</h2>
                      <form id="search-form">
                          <input type="text" id="query" class="search-box" placeholder="Search for options concepts, strategies, etc.">
                          <button type="submit" class="button">Search</button>
                      </form>
                      <div id="results"></div>
                  </div>
                  
                  <div id="InfoTab" class="tabcontent">
                      <h2>System Information</h2>
                      <h3>Current Status</h3>
                      <ul>
                          <li>Search Engine: {{ "‚úÖ Semantic search" if vector_status == "‚úÖ Available" else "üîç Keyword search" }}</li>
                          <li>Vector Store: {{ vector_status }}</li>
                          <li>Transcript Files: {{ transcript_count }}</li>
                          <li>Application Version: 2.0</li>
                          <li>Last Updated: {{ timestamp }}</li>
                      </ul>
                      
                      <h3>Environment Information</h3>
                      <ul>
                          <li>Python Version: {{ python_version }}</li>
                          <li>Web Framework: Flask {{ flask_version }}</li>
                          <li>Current Time: {{ timestamp }}</li>
                      </ul>
                      
                      <h3>Files</h3>
                      <p><strong>App Files:</strong> {{ file_list }}</p>
                      <p><strong>Static Files:</strong> {{ static_files }}</p>
                      <p><strong>Template Files:</strong> {{ template_files }}</p>
                      
                      <h3>About This App</h3>
                      <p>This application provides semantic search across a collection of options trading transcripts and videos.</p>
                      <p>The search uses embeddings from the SentenceTransformer model to find the most relevant content based on your query.</p>
                      {% if building_vector_store %}
                      <div class="maintenance-notice">
                        <strong>üöß Vector Store Building:</strong> The semantic search index is currently being built. This may take a few minutes.
                      </div>
                      {% endif %}
                  </div>
              </div>
              
              <script src="{{ url_for('static', filename='script.js') }}"></script>
              
              <script>
              // Add polling for vector store status if it's building
              {% if building_vector_store %}
              let checkStatusInterval = setInterval(function() {
                  fetch('/api/status')
                      .then(response => response.json())
                      .then(data => {
                          if (!data.building_vector_store) {
                              // Vector store build finished
                              clearInterval(checkStatusInterval);
                              // Show success message
                              const notice = document.getElementById('status-notice');
                              if (data.vector_store_available) {
                                  notice.innerHTML = '<strong>‚úÖ Ready:</strong> Semantic search is now available!';
                              } else {
                                  notice.innerHTML = '<strong>‚ùå Error:</strong> Could not build vector store. Using keyword search.';
                              }
                              // Refresh page after 2 seconds
                              setTimeout(() => location.reload(), 2000);
                          }
                      })
                      .catch(error => console.error('Error checking status:', error));
              }, 5000); // Check every 5 seconds
              {% endif %}
              </script>
          </body>
          </html>
          EOF
          
          # Create a simple gunicorn starter for HF Spaces
          cat > start.sh <<'EOF'
          #!/bin/bash
          
          # Ensure executable
          chmod +x start.sh
          
          # Print environment info
          echo "Starting application..."
          python3 --version
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          
          # Run Flask app with gunicorn
          exec python3 app.py
          EOF
          
          # Make start.sh executable
          chmod +x start.sh
          
          # Update the README to properly run Flask app
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: üî•
          colorFrom: blue
          colorTo: red
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          
          # Options Trading Knowledge Search
          
          This application provides semantic search across a collection of options trading transcripts and videos.
          
          ## Features
          
          - Semantic search using sentence-transformers
          - FAISS vector database for fast retrieval
          - Direct links to specific timestamps in relevant videos
          EOF
          
          # Create Dockerfile for Hugging Face Spaces
          cat > Dockerfile <<'EOF'
          FROM python:3.9-slim
          
          WORKDIR /app
          
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          # Copy the application files
          COPY app.py .
          COPY static/ ./static/
          COPY templates/ ./templates/
          
          EXPOSE 7860
          
          # Run the Flask app directly
          CMD ["python", "app.py"]
          EOF
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 