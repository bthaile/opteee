name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt specifically for Hugging Face
          cat > requirements.txt.new <<EOL
          # Pin specific versions that work together
          torch==1.13.1
          transformers==4.31.0
          tokenizers==0.14.1
          # Add other dependencies below but don't specify versions unless needed
          # This will let pip resolve compatible versions
          EOL
          
          # Append existing requirements without versions
          if [ -f requirements.txt ]; then
            grep -v "torch\|transformers\|tokenizers" requirements.txt | grep -v "==" >> requirements.txt.new || true
          fi
          
          # Replace the original requirements
          mv requirements.txt.new requirements.txt
          
          # Create a specific Hugging Face runtime.txt
          echo "python-3.10" > runtime.txt
          
          # Update README.md while preserving HF configuration
          if [ -f README.md ]; then
            # Check if README already has HF configuration
            if grep -q "^---" README.md && grep -q "sdk:" README.md; then
              # Preserve existing configuration and add our notes
              sed -n '/^---/,/^---/p' README.md > README.md.new
              cat >> README.md.new <<EOL
              
              # HuggingFace Space for opteee
              
              This space runs with specific dependency versions:
              - torch==1.13.1
              - transformers==4.31.0
              - tokenizers==0.14.1
              EOL
              # Add the rest of README after the frontmatter
              sed '1,/^---/d' README.md | sed '1,/^---/d' >> README.md.new || true
            else
              # Create new README with default configuration
              cat > README.md.new <<EOL
              ---
              title: opteee
              emoji: ðŸ”¥
              colorFrom: blue
              colorTo: red
              sdk: gradio
              sdk_version: 4.19.2
              app_file: app.py
              pinned: false
              ---
              
              # HuggingFace Space for opteee
              
              This space runs with specific dependency versions:
              - torch==1.13.1
              - transformers==4.31.0
              - tokenizers==0.14.1
              EOL
            fi
            mv README.md.new README.md
          else
            # No README exists, create one with default configuration
            cat > README.md <<EOL
            ---
            title: opteee
            emoji: ðŸ”¥
            colorFrom: blue
            colorTo: red
            sdk: gradio
            sdk_version: 4.19.2
            app_file: app.py
            pinned: false
            ---
            
            # HuggingFace Space for opteee
            
            This space runs with specific dependency versions:
            - torch==1.13.1
            - transformers==4.31.0
            - tokenizers==0.14.1
            EOL
          fi
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 