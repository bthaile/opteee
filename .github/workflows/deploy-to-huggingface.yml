name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt with minimal dependencies for build time
          cat > requirements.txt <<EOF
          # Very minimal dependencies to avoid conflicts
          flask==2.0.1
          markdown==3.3.7
          python-dotenv==0.21.0
          numpy==1.23.5
          EOF
          
          # Create runtime_requirements.txt with exact versions for runtime
          cat > runtime_requirements.txt <<EOF
          # Exact versions for runtime compatibility
          huggingface_hub==0.10.1
          transformers==4.20.1
          tokenizers==0.12.1
          sentence_transformers==2.1.0
          faiss-cpu==1.7.3
          EOF
          
          # Create a simple Flask app instead of gradio
          cat > app.py <<'EOF'
          from flask import Flask, request, render_template_string, jsonify
          import os
          import sys
          import json
          from datetime import datetime
          
          # Create Flask app
          app = Flask(__name__)
          
          # HTML template for the main page
          MAIN_TEMPLATE = """
          <!DOCTYPE html>
          <html>
          <head>
              <title>Options Trading Knowledge Search</title>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  body { 
                      font-family: Arial, sans-serif; 
                      max-width: 800px; 
                      margin: 0 auto; 
                      padding: 20px;
                      line-height: 1.6;
                  }
                  .container { 
                      background-color: #f9f9f9; 
                      padding: 20px; 
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .search-box {
                      width: 100%;
                      padding: 12px;
                      margin: 8px 0;
                      box-sizing: border-box;
                      border: 2px solid #ccc;
                      border-radius: 4px;
                      font-size: 16px;
                  }
                  .button {
                      background-color: #4CAF50;
                      color: white;
                      padding: 12px 20px;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 16px;
                  }
                  .button:hover {
                      background-color: #45a049;
                  }
                  .tab {
                      overflow: hidden;
                      border: 1px solid #ccc;
                      background-color: #f1f1f1;
                      border-radius: 4px 4px 0 0;
                  }
                  .tab button {
                      background-color: inherit;
                      float: left;
                      border: none;
                      outline: none;
                      cursor: pointer;
                      padding: 14px 16px;
                      transition: 0.3s;
                      font-size: 16px;
                  }
                  .tab button:hover {
                      background-color: #ddd;
                  }
                  .tab button.active {
                      background-color: #ccc;
                  }
                  .tabcontent {
                      display: none;
                      padding: 20px;
                      border: 1px solid #ccc;
                      border-top: none;
                      border-radius: 0 0 4px 4px;
                      animation: fadeEffect 1s;
                  }
                  @keyframes fadeEffect {
                      from {opacity: 0;}
                      to {opacity: 1;}
                  }
                  #results {
                      margin-top: 20px;
                  }
                  .result-item {
                      margin-bottom: 20px;
                      padding: 15px;
                      border: 1px solid #e1e1e1;
                      border-radius: 4px;
                      background-color: white;
                  }
                  .result-title {
                      font-weight: bold;
                      font-size: 18px;
                      margin-bottom: 5px;
                  }
                  .result-meta {
                      font-size: 14px;
                      color: #666;
                      margin-bottom: 10px;
                  }
                  .result-content {
                      margin-top: 10px;
                  }
                  .unavailable {
                      color: #888;
                      font-style: italic;
                  }
                  .maintenance-notice {
                      background-color: #fffbea;
                      border-left: 4px solid #f0b429;
                      padding: 12px;
                      margin-bottom: 20px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Options Trading Knowledge Search</h1>
                  
                  <div class="maintenance-notice">
                      <strong>‚ö†Ô∏è Limited Functionality:</strong> The search engine is currently being upgraded to use newer libraries.
                      Some features may be unavailable during this maintenance period.
                  </div>
                  
                  <div class="tab">
                      <button class="tablinks active" onclick="openTab(event, 'SearchTab')">Search</button>
                      <button class="tablinks" onclick="openTab(event, 'InfoTab')">System Info</button>
                  </div>
                  
                  <div id="SearchTab" class="tabcontent" style="display: block;">
                      <h2>Search Options Trading Knowledge</h2>
                      <form id="search-form" onsubmit="return performSearch()">
                          <input type="text" id="query" class="search-box" placeholder="Enter your search query...">
                          <button type="submit" class="button">Search</button>
                      </form>
                      <div id="results"></div>
                  </div>
                  
                  <div id="InfoTab" class="tabcontent">
                      <h2>System Information</h2>
                      <h3>Current Status</h3>
                      <ul>
                          <li>Vector Store: ‚ö†Ô∏è In maintenance mode</li>
                          <li>Application Version: 1.0</li>
                          <li>Last Updated: {{timestamp}}</li>
                      </ul>
                      
                      <h3>Environment Information</h3>
                      <ul>
                          <li>Python Version: {{python_version}}</li>
                          <li>Web Framework: Flask {{flask_version}}</li>
                          <li>Current Time: {{timestamp}}</li>
                      </ul>
                      
                      <h3>About This App</h3>
                      <p>This application provides semantic search across a collection of options trading transcripts and videos.</p>
                      <p>The search uses embeddings to find the most relevant content based on your query.</p>
                      
                      <h3>Files in Directory</h3>
                      <p>{{file_list}}</p>
                  </div>
              </div>
              
              <script>
                  function openTab(evt, tabName) {
                      var i, tabcontent, tablinks;
                      tabcontent = document.getElementsByClassName("tabcontent");
                      for (i = 0; i < tabcontent.length; i++) {
                          tabcontent[i].style.display = "none";
                      }
                      tablinks = document.getElementsByClassName("tablinks");
                      for (i = 0; i < tablinks.length; i++) {
                          tablinks[i].className = tablinks[i].className.replace(" active", "");
                      }
                      document.getElementById(tabName).style.display = "block";
                      evt.currentTarget.className += " active";
                  }
                  
                  function performSearch() {
                      const query = document.getElementById('query').value;
                      if (!query) {
                          alert('Please enter a search query');
                          return false;
                      }
                      
                      fetch('/api/search?q=' + encodeURIComponent(query))
                          .then(response => response.json())
                          .then(data => {
                              const resultsDiv = document.getElementById('results');
                              if (data.status === 'maintenance') {
                                  resultsDiv.innerHTML = '<div class="maintenance-notice"><strong>Maintenance Mode:</strong> ' + 
                                  data.message + '</div>' + generateSampleResults(query);
                              } else {
                                  resultsDiv.innerHTML = '<h3>Search Results for: "' + query + '"</h3>';
                                  if (data.results && data.results.length > 0) {
                                      data.results.forEach(result => {
                                          resultsDiv.innerHTML += generateResultHTML(result);
                                      });
                                  } else {
                                      resultsDiv.innerHTML += '<p>No results found.</p>';
                                  }
                              }
                          })
                          .catch(error => {
                              console.error('Error:', error);
                              document.getElementById('results').innerHTML = 
                                  '<p>An error occurred during search. Please try again later.</p>';
                          });
                      
                      return false;
                  }
                  
                  function generateSampleResults(query) {
                      return `
                          <h3>Sample Results for: "${query}"</h3>
                          <p class="unavailable">Real search is unavailable during maintenance. Here are some example results:</p>
                          
                          <div class="result-item">
                              <div class="result-title">Understanding Options Basics</div>
                              <div class="result-meta">at 05:23 ‚Ä¢ Score: 0.8654</div>
                              <a href="#" style="text-decoration:none;">üîó Watch Video</a>
                              <div class="result-content">
                                  <strong>Content:</strong> This would typically show a relevant portion of transcript about options trading basics...
                              </div>
                          </div>
                          
                          <div class="result-item">
                              <div class="result-title">Options Strategies for Beginners</div>
                              <div class="result-meta">at 12:45 ‚Ä¢ Score: 0.7621</div>
                              <a href="#" style="text-decoration:none;">üîó Watch Video</a>
                              <div class="result-content">
                                  <strong>Content:</strong> Information about beginner options strategies would appear here...
                              </div>
                          </div>
                      `;
                  }
                  
                  function generateResultHTML(result) {
                      return `
                          <div class="result-item">
                              <div class="result-title">${result.title || 'Untitled'}</div>
                              <div class="result-meta">at ${result.timestamp || '00:00'} ‚Ä¢ Score: ${result.score.toFixed(4)}</div>
                              <a href="${result.url || '#'}" style="text-decoration:none;">üîó Watch Video</a>
                              <div class="result-content">
                                  <strong>Content:</strong> ${result.content || 'No content available'}
                              </div>
                          </div>
                      `;
                  }
              </script>
          </body>
          </html>
          """
          
          @app.route('/')
          def home():
              """Render the home page"""
              # Get system info for the Info tab
              flask_version = "2.0.1"  # Hardcoded for simplicity
              python_version = sys.version.split()[0]
              timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              file_list = ', '.join(sorted([f for f in os.listdir() if os.path.isfile(f)])[:10]) + '...'
              
              return render_template_string(
                  MAIN_TEMPLATE, 
                  flask_version=flask_version,
                  python_version=python_version,
                  timestamp=timestamp,
                  file_list=file_list
              )
          
          @app.route('/api/search')
          def search_api():
              """Simple API endpoint for search"""
              query = request.args.get('q', '')
              
              # Return maintenance mode response
              return jsonify({
                  'status': 'maintenance',
                  'message': 'The search functionality is currently being updated to work with newer dependencies.',
                  'query': query
              })
          
          # Run the Flask app
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 7860)))
          EOF
          
          # Create a simple gunicorn starter for HF Spaces
          cat > start.sh <<'EOF'
          #!/bin/bash
          
          # Ensure executable
          chmod +x start.sh
          
          # Print environment info
          echo "Starting application..."
          python3 --version
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          
          # Run Flask app with gunicorn
          exec python3 app.py
          EOF
          
          # Make start.sh executable
          chmod +x start.sh
          
          # Update the README to use start.sh
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: üî•
          colorFrom: blue
          colorTo: red
          sdk: static
          pinned: false
          ---
          
          # Options Trading Knowledge Search
          
          This application provides semantic search across a collection of options trading transcripts and videos.
          
          ## Features
          
          - Semantic search using sentence-transformers
          - FAISS vector database for fast retrieval
          - Direct links to specific timestamps in relevant videos
          EOF
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 