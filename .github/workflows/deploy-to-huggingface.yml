name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only fetch the latest commit

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Set default branch name to main
          git config --global init.defaultBranch main
          
      - name: Create Hugging Face specific files
        run: |
          # Create packages.txt for system dependencies
          echo "" > packages.txt
          
          # Create requirements.txt specifically for Hugging Face
          cat > requirements.txt <<EOF
          # Pin specific versions that work together
          torch==1.13.1
          transformers==4.26.0
          tokenizers==0.13.3
          huggingface_hub>=0.12.1
          # Vector store and other requirements
          faiss-cpu
          python-dotenv
          sentence_transformers==2.2.2
          gradio
          # Add other dependencies below but don't specify versions unless needed
          EOF
          
          # Create patch script for sentence_transformers
          cat > direct_patch.py <<'EOF'
          """
          Direct patching of sentence_transformers files without importing the module
          """
          import os
          import re
          import sys
          import site
          
          def find_sentence_transformers_path():
              """Find sentence_transformers package path without importing it"""
              # Check site-packages directories
              for site_dir in site.getsitepackages():
                  st_dir = os.path.join(site_dir, "sentence_transformers")
                  if os.path.exists(st_dir) and os.path.isdir(st_dir):
                      return st_dir
              
              # Check current directory
              if os.path.exists("sentence_transformers") and os.path.isdir("sentence_transformers"):
                  return "sentence_transformers"
                  
              return None
              
          def patch_file(file_path):
              """Patch a single file to replace cached_download with hf_hub_download"""
              if not os.path.exists(file_path):
                  print(f"File not found: {file_path}")
                  return False
                  
              print(f"Checking {file_path}")
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
                  
              if 'cached_download' in content:
                  print(f"  Found cached_download in {file_path}, patching...")
                  
                  # Replace imports
                  new_content = re.sub(
                      r'from huggingface_hub import cached_download', 
                      'from huggingface_hub import hf_hub_download', 
                      content
                  )
                  
                  # Also check for import huggingface_hub
                  new_content = re.sub(
                      r'from huggingface_hub import ([^,]*), cached_download(.*)', 
                      r'from huggingface_hub import \1, hf_hub_download\2', 
                      new_content
                  )
                  
                  # Replace function calls - might need adjustment
                  new_content = re.sub(
                      r'cached_download\s*\(([^)]*)\)', 
                      r'hf_hub_download(repo_id="sentence-transformers/all-MiniLM-L6-v2", filename=\1)', 
                      new_content
                  )
                  
                  with open(file_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                      
                  print(f"  âœ… Successfully patched {file_path}")
                  return True
              else:
                  print(f"  No cached_download found in {file_path}")
                  return False
              
          def patch_st_files():
              """Patch sentence_transformers files to use hf_hub_download"""
              patched_files = []
              
              # First patch app files
              app_files = [
                  "create_vector_store.py",
                  "app.py"
              ]
              
              for file_path in app_files:
                  if os.path.exists(file_path):
                      if patch_file(file_path):
                          patched_files.append(file_path)
              
              # Then patch sentence_transformers
              st_path = find_sentence_transformers_path()
              if not st_path:
                  print("âŒ Could not find sentence_transformers installation")
              else:
                  print(f"Found sentence_transformers at: {st_path}")
                  
                  # Files to patch
                  files_to_patch = [
                      os.path.join(st_path, "models", "Transformer.py"),
                      os.path.join(st_path, "SentenceTransformer.py"),
                      os.path.join(st_path, "util.py"),
                      # Recursively search for all Python files
                      *[os.path.join(dp, f) for dp, dn, filenames in os.walk(st_path) 
                        for f in filenames if f.endswith('.py')]
                  ]
                  
                  # Remove duplicates
                  files_to_patch = list(set(files_to_patch))
                  
                  for file_path in files_to_patch:
                      if patch_file(file_path):
                          patched_files.append(file_path)
              
              if patched_files:
                  print(f"âœ… Successfully patched {len(patched_files)} files")
                  return True
              else:
                  print("âŒ No files required patching")
                  return False
                  
          if __name__ == "__main__":
              success = patch_st_files()
              sys.exit(0 if success else 1)
          EOF
          
          # Create app startup wrapper script
          cat > app_wrapper.py <<'EOF'
          """
          Wrapper script to patch sentence_transformers before starting the app
          """
          import sys
          import os
          import subprocess

          # Directly patch the files without importing
          try:
              print("Running direct patching of sentence_transformers...")
              result = subprocess.run([sys.executable, "direct_patch.py"], 
                                    capture_output=True, text=True)
              print(result.stdout)
              if result.stderr:
                  print("Patching errors:", result.stderr)
                  
              if result.returncode == 0:
                  print("âœ… Patching successful")
              else:
                  print("âŒ Patching failed")
          except Exception as e:
              print(f"âŒ Error during patching: {e}")

          # Import and run the original app
          try:
              sys.path.insert(0, os.getcwd())
              from app import app as gradio_app

              # This is needed for Gradio on HuggingFace Spaces
              app = gradio_app
          except Exception as e:
              print(f"âŒ Error importing app: {e}")
              # Create a minimal error app
              import gradio as gr
              app = gr.Interface(
                  fn=lambda x: f"Application failed to start: {str(e)}",
                  inputs=gr.Textbox(placeholder="Enter text here..."),
                  outputs=gr.Textbox()
              )
          EOF
          
          # Update the README to use app_wrapper.py instead
          cat > README.md <<EOF
          ---
          title: opteee
          emoji: ðŸ”¥
          colorFrom: blue
          colorTo: red
          sdk: gradio
          sdk_version: 4.19.2
          app_file: app_wrapper.py
          pinned: false
          ---
          
          # HuggingFace Space for opteee
          
          This space runs with specific dependency versions and patches:
          - torch==1.13.1
          - transformers==4.26.0
          - tokenizers==0.13.3
          - sentence_transformers with huggingface_hub compatibility patch
          EOF
          
          echo "Created HuggingFace-specific configuration files:"
          ls -la

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_NAME: "bthaile/opteee"
        run: |
          # Set credentials helper to store token
          git config --global credential.helper store
          
          # Store the Hugging Face token in the credentials helpers
          echo "https://USER:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
          
          # Create a new repository with only the current content
          rm -rf .git
          git init
          git add .
          git commit -m "Deploy to Hugging Face with fixed dependencies"
          
          # Add Hugging Face Space as a Git remote
          git remote add space https://huggingface.co/spaces/$SPACE_NAME
          
          # Force push to Hugging Face Space
          git push --force space main 